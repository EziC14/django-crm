{% load humanize %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>CRM - Customers</title>
    <style>
      table { border-collapse: collapse; width: 100%; }
      th, td { padding: 8px; border: 1px solid #ddd; }
      th { background: #f5f5f5; }
      .controls { margin-bottom: 1em; }
    </style>
  </head>
  <body>
    <h1>Customers</h1>

    <div class="controls">
      <form method="get">
        <input type="text" name="q" placeholder="Search name or company" value="{{ request.GET.q|default_if_none:'' }}">
        <label><input type="checkbox" name="birthday" value="this_week" {% if request.GET.birthday == 'this_week' %}checked{% endif %}> Birthdays this week</label>
        <select name="sort">
          <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>Name</option>
          <option value="company" {% if request.GET.sort == 'company' %}selected{% endif %}>Company</option>
          <option value="birthday" {% if request.GET.sort == 'birthday' %}selected{% endif %}>Birthday</option>
          <option value="last_interaction" {% if request.GET.sort == 'last_interaction' %}selected{% endif %}>Last Interaction</option>
        </select>
        <button type="submit">Apply</button>
      </form>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Company</th>
          <th>Birthday</th>
          <th>Last Interaction</th>
        </tr>
      </thead>
      <tbody>
        {% for customer in page_obj.object_list %}
        <tr>
          <td>{{ customer.full_name }}</td>
          <td>{{ customer.company.name }}</td>
          <td>{% if customer.birthday %}{{ customer.birthday|date:"F j" }}{% endif %}</td>
          <td>
            {% if customer.last_interaction_ts %}
              {{ customer.last_interaction_ts|timesince }} ago ({{ customer.last_interaction_type|title }})
            {% else %}
              â€”
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No customers found.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination">
      <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Previous</a>
      {% endif %}
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Next</a>
      {% endif %}
    </div>
  </body>
</html>
